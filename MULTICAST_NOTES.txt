# MULTICAST

Multicast traffic distribution uses the concept of “constrained” flooding, i.e. 
traffic is flooded only on the links that lead to the actual group subscribers. 
The process has 2 parts:
  *  Building a multicast distribution tree for a group—aka Shortest Path Tree or SPT.
  *  Flooding the actual multicast packets down the SPT, while performing Reverse Path
     Forwarding (RPF) to avoid loops.


# PIM RPF CHECK AND FORWARDING
PIM uses the unicast routing table to perform RPF checks.
When the router receives a multicast packet, it looks at the source IP address for the packet.
The router looks up the source IP address in the unicast routing table and determines the 
outgoing interface for this packet. If this outgoing interface does not match the interface 
where the packet was received, the router drops the packet.

If the RPF check is passed, the router will determine the outgoing interface list (OIL) 
The OIL never includes the input interface; this is the well-known split horizon rule.
PIM needs to be globally enabled:
```
ip multicast-routing distributed
```

Note you can change RPF by adding:
- static routes: carefull as it actually change the routing path
- multicast route: ```ip mroute <SOURCE> <MASK> [RPF-IP-Address|<Interface-Name>] [distance]```
  This commands only change RPF check behaviour.
  Note: the mroute table is ordered based on the actul commands, so put the msot specific first

You can debug RPF using:
```
debug ip mfib pak

You might need these 2 as well to actually see the debug
no ip mfib cef input 
no ip mfib cef output
```

# PIM DENSE MODE

*  Does not use any explicit signaling to create the SPT
*  It floods a packet out of all the interfaces enabled for multicast (except the source interface)
*  if the downstream router does not have subscriber, it will send upstream a **PRUNE** message for the group
   *  as a consequence the link to the downstream router will be removed from OIL
   *  PRUNE MEssage is valid for 3 minutes (default), after that traffic is sent again
*  DM nees to be enabled interface per interface
   ```
   interface <X>
     ip pim dense-mode
   ```
*  Verify commands
   ```
   show ip pim neighbor
   show ip pim interface
   show ip mroute   

   Note that in show ip mroute, 
     - the (*,G) will have all the interfaces in the OIL, this entry will have the D flag
     - the (S,G) will have the T bit (traffic in shortest Path)
     - the RP value is 0.0.0.0 (RPF not used)
     - the RPF value is all 0 if the source is directly connected, otherwise it's the upstream neighbor

   show ip rpf <source>
   will get the information about the RPF interface for a specific source 
   ```


# PIM SPARSE MODE
PIM SM builds explicit multicast distribution trees from the receivers to the sources. 
It uses Rendezvous Point (RP)to faciliate discovery of endpoints (sources/destinations):
*  An RP is a known to both sources and receivers. 
   *  A Receiver (for a group: G) router first builds a tree to the RP; this is called **SHARED TREE** or (*,G)
      This is done by sending upstream **PIM JOIN** messages toward the RP
   *  When a source appears in the network, the **closest multicast router** will contact the RP 
      using **PIM Register** messages; these messages are encapsulated in a unicast packet and sent to the RP. 
      **Note:** a dynamic (non configurable) Tunnel interface is created on all routers in the PIM network to 
      encapsulate the register messages to the RP
      **Note:** PIM should be enabled along the shortest path to the RP, or the RPF check for the RP will fail 
      and the registration will not be completed.
   *  The RP builds a new SPT toward the source using **PIM Join** messages and starts forwarding traffic down 
      the (*,G) tree.
   *  **SPT switchover**: when the receivers see traffic going down the (*,G) tree from a source, they initiate 
       a **PIM Join** toward the source, building another SPT designated as the (S,G) (falt will be set to T)
      Also a **Prune** message is sent to the RP as we don't need the traffic from (*,G) anymore 
      Nete: you can set a threshold for the switchover to happen (and possibly disable it completely):
      ```ip pim spt-threshold [<Rate in Kbps>|infinity]```


## PIM SPARSE MODE - STATIC RP
You can configure the RP in a static way (note: static takes precendence over dynamic here):

```
ip pim rp-address <IP> [<ACL>] [override] .
```
The ACL parameter lists the groups that are mapped to this particular RP. 
The **override** parameter will force the router to retain static information even if a different RP for the group 
is learned via Auto-RP/BSR.

## PIM SPARSE MODE - ASSERT




# PIM SPARSE DENSE MODE
PIM Sparse-Dense mode is a hybrid of the Sparse and Dense mode operations. When you apply the command:
```ip pim sparse-dense-mode``` to an interface, the router will forward traffic for both sparse and dense groups 
out of this interface. This means, if you hav an RP for a group it will use SPARSE mode otherwise it will use 
DENSE mode. (This is useful in cases where the RP is learn dynamically, but overall **DO NOT USE IT**)
Use the command: ```no ip pim dm-fallback``` on all PIM SM/DM routers to prevent the DM fallback behavior 
and only allow forwarding for sparse-mode groups.
