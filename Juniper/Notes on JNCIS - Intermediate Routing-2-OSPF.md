# Junos Intermediate Routing - 2 - OSPF


# OSPF Summary
Juniper has preference (i.e. administrative distance) is 10
By default the metric is referencing a 100Mb interface so everything above: GE/10G/etc.. that will have cost 1
so we need to change the cost reference (set it to 400-500G seems reasonable these days).
You can change the bandwidth reference with: `set protocols ospf reference-bandwidth 100g`

## Requirements to become **neighbours**:
- same ospf areas
- same authentication settings
- same subnet (mask)
- same network type and stub flags
- same timers (hello and dead timers)

## Neighbours States:
 - Down
 - Init Hello: Seen [null], <Local_RID>
 - 2-way Hello: Seen [<Remote_RID>], <Local_RID> .  
   We received one hello from a neighbour, we add it to the list of neighbours seen
   Routers will stay in this state if there is a DR/BDR and these routers are none of those.
 - DR Election (if requried): The Hello will have the local ID as DR (or if a DR is known the known DR)
 - Exstart State: DBD packets exchanged with LSA Headers
 - Exchange State: 
 - Loading State: Information is exchanged via LSR, LSU an LSAck
 - Full State

## Packets:
Hello packets content:
 - destination address is 224.0.0.5
 - IP protocol is 89
 - router-id
 - DR and BDR if any
 - active neighbours
 - area-id
 - authentication type
 - dead timer (hello is 10 seconds)

 DBD Packet content:
 - destination address is peer unicast IP 
 - IP protocol is 89
 - source router id
 - area-id 
 - Summary List of network the router knows about(?)

Link State Request Packet content:
 - destination address is peer unicast IP 
 - IP protocol is 89
 - source router id
 - area-id 
 - List of networks the local router wants to know about from the peer (LSRs)

 Link State Update Packet content:
 - destination address is peer unicast IP 
 - IP protocol is 89
 - source router id
 - area-id 
 - List of records related to the Networks requested in an LSR

Link State Ack Packet content:
 - confirmation that the LSUpdate has been received

## Network Types
| Network Type            | Hello Timer | Dead Timer | DR/BDR |
| ----------------------- | ----------- | ---------- | ------ |
| Broadcast               |     10      |    40      |    Yes |
| Non Broadcast           |     30      |   120      |    Yes |
| Point-2-Point           |     10      |    40      |    No  |
| Point-2-Multipoint      |     30      |   120      |    No  |
| Point-2-Multipoint (NB) |     30      |   120      |    No  |
|  |  |  |  |


## Area Types
In a very practical way, an OSPF Area is a (hopefully connected) subset of the OSPF domain and aside from area 0
which takes the role of the **backbone**, **transit** for traffic between different areas.  
The other areas don't have a specific meaning or function.  
Each router interface is assigned to an area, so a router can be part of different areas, and in this case it's called: **Area Border Router (ABR)**  
Area Types are a way to control what LSAs are allowed inside the specific area.

Aside from normal areas we have:  
- **Stub:**: will only allow type-1 Router from the local Area routers, type-2 Network from the local Area DRs and type-3 for Summary routes from the ABRs.  
- **Totally Stub:**: this is similar to the **stub** but there are no Summary LSA with the exception of a **default** generated by the **ABR**.  
- **Not-So-Stubby:**: this is similar to the **stub** but in addition to the 3 LSAs types allowed in a stub area, we also allow routers in this area | to redistribute routes. Because type-5 are not allowed, **redistributed routes are sent as type-7 LSA**; when these type-7 reach an **ABR** they are translated back to type-5 in the backbone in the rest of the OSPF domain. Finally the ABR also create a type-4 LSA to advertise the **ASBR** in the Not-So-Stubby area (of course this is the same behaviour we would have when redistribution happens in a normal area)
- **Totally-Not-So-Stubby:**: this is the same as Not-So-Stubby area but like the Totally Stub will only allow at most one Summary for the default route

Notes:
- **Remember** that flags need to match when you configure peering from routers in different flavour of stub areas.
- **IMPORTANT: In Juniper you only have one loopback and it can only be assigned to an area!**  
  You can however configure extra logical interfaces and redistribute those.. example
  ```
  [type-3 LSA generation from logical interface]
  set chassis fpc 0 pic 0 tunnel-services bandwidth 10g
  set interfaces lt-0/0/0 unit 1 peer-unit 2
  set interfaces lt-0/0/0 unit 2 peer-unit 1
  set interfaces lt-0/0/0 unit 1 encapsulation ethernet
  set interfaces lt-0/0/0 unit 1 family inet address 203.0.113.1/24
  set interfaces lt-0/0/0 unit 2 encapsulation ethernet-ccc
  set interfaces lt-0/0/0 unit 2 family ccc
  set protocols ospf area 1 interface lt-0/0/0.1 passive

  [type-5 LSA generation]
  !
  ! The receive option in the static route means do not use the route to forward traffic, 
  ! it's to be received by the routing engine
  !
  set routing-options static route 203.0.113.0/24 receive  
  set policy-options policy-statement PL-EX-OSPF term 1 from route-filter 203.0.113.0/24 exact
  set policy-options policy-statement PL-EX-OSPF term 1 then accept
  set protocols ospf export PL-EX-OSPF 
  ```

### LSA Types in different Areas Summary:
| Area Type  \ LSA Type   | LSA1 | LSA2 | LSA3 | LSA4 | LSA5 | LSA7 | 
| ----------------------- | ---- | ---- | ---- | ---- | ---- | ---- |
| Backbone                | Yes  | Yes  | Yes  |  Yes | Yes  | No   | 
| Non Backboe             | Yes  | Yes  | Yes  |  Yes | Yes  | No   | 
| Stub                    | Yes  | Yes  | Yes  |  No  | No   | No   | 
| Totally Stubby          | Yes  | Yes  | No   |  No  | No   | No   | 
| Not-so-Stubby           | Yes  | Yes  | Yes  |  No  | No   | Yes  | 
|  |  |  |  |

## Basic Configuration Setup

<img src="pictures/Basic 4 Routers.png" alt="Basic 4 routers jlab topology" style="height: 600px; width:800px;"/>

Note: this configuration does not cover the cross diagonal links R1<>R4 and R2<>R3

```
[R1]
set system host-name R1
set interfaces ge-0/0/0 unit 0 family inet address 10.0.12.1/24
set interfaces ge-0/0/1 unit 0 family inet address 10.100.14.1/24
set interfaces ge-0/0/2 unit 0 family inet address 10.0.13.1/24
set interfaces lo0 unit 0 family inet address 1.1.1.1/32
!
set protocols ospf area 0.0.0.0 interface ge-0/0/0.0
set protocols ospf area 0.0.0.0 interface ge-0/0/1.0
set protocols ospf area 0.0.0.0 interface ge-0/0/2.0
set protocols ospf area 0.0.0.0 interface lo0.0 passive
set protocols ospf reference-bandwidth 100g
!
! to enable load balancing
set policy-options policy-statement Load-Balance term 1 from route-filter 0.0.0.0/0 orlonger
set policy-options policy-statement Load-Balance term 1 then load-balance per-packet
set routing-options forwarding-table export Load-Balance
!
set routing-options router-id 1.1.1.1

[R2]
set system host-name R2

set interfaces ge-0/0/0 unit 0 family inet address 10.0.12.2/24
set interfaces ge-0/0/1 unit 0 family inet address 10.100.23.1/24
set interfaces ge-0/0/2 unit 0 family inet address 10.0.24.2/24
set interfaces lo0 unit 0 family inet address 2.2.2.2/32
!
set protocols ospf area 0.0.0.0 interface ge-0/0/0.0
set protocols ospf area 0.0.0.0 interface ge-0/0/1.0
set protocols ospf area 0.0.0.0 interface ge-0/0/2.0
set protocols ospf area 0.0.0.0 interface lo0.0 passive
set protocols ospf reference-bandwidth 100g
!
! to enable load balancing
set policy-options policy-statement Load-Balance term 1 from route-filter 0.0.0.0/0 orlonger
set policy-options policy-statement Load-Balance term 1 then load-balance per-packet
set routing-options forwarding-table export Load-Balance

!
set routing-options router-id 2.2.2.2


[R3]
set system host-name R3
!
set interfaces ge-0/0/0 unit 0 family inet address 10.0.34.3/24
set interfaces ge-0/0/1 unit 0 family inet address 10.100.23.2/24
set interfaces ge-0/0/2 unit 0 family inet address 10.0.13.3/24
set interfaces lo0 unit 0 family inet address 3.3.3.3/32
!
set protocols ospf area 0.0.0.0 interface ge-0/0/0.0
set protocols ospf area 0.0.0.0 interface ge-0/0/1.0
set protocols ospf area 0.0.0.1 interface ge-0/0/2.0
set protocols ospf area 0.0.0.0 interface lo0.0 passive
set protocols ospf reference-bandwidth 100g
!
! to enable load balancing
set policy-options policy-statement Load-Balance term 1 from route-filter 0.0.0.0/0 orlonger
set policy-options policy-statement Load-Balance term 1 then load-balance per-packet
set routing-options forwarding-table export Load-Balance

!
set routing-options router-id 3.3.3.3

[R4]
set system host-name R4
!
set interfaces ge-0/0/0 unit 0 family inet address 10.0.34.4/24
set interfaces ge-0/0/1 unit 0 family inet address 10.100.14.2/24
set interfaces ge-0/0/2 unit 0 family inet address 10.0.24.4/24
set interfaces lo0 unit 0 family inet address 4.4.4.4/32
!
set protocols ospf area 0.0.0.0 interface ge-0/0/0.0
set protocols ospf area 0.0.0.0 interface ge-0/0/1.0
set protocols ospf area 0.0.0.0 interface ge-0/0/2.0
set protocols ospf area 0.0.0.0 interface lo0.0 passive
set protocols ospf reference-bandwidth 100g
!
! to enable load balancing
set policy-options policy-statement Load-Balance term 1 from route-filter 0.0.0.0/0 orlonger
set policy-options policy-statement Load-Balance term 1 then load-balance per-packet
set routing-options forwarding-table export Load-Balance

!
set routing-options router-id 4.4.4.4

```
Basic show commands:
```
-------------------------------------

R1> show ospf overview [ extensive ]
Instance: master
  Router ID: 1.1.1.1
  Route table index: 0
  LSA refresh time: 50 minutes
  Post Convergence Backup: Disabled
  Area: 0.0.0.0
    Stub type: Not Stub
    Authentication Type: None
    Area border routers: 0, AS boundary routers: 0
    Neighbors
      Up (in full state): 3
  Topology: default (ID 0)
    Prefix export count: 0
    Full SPF runs: 56
    SPF delay: 0.200000 sec, SPF holddown: 5 sec, SPF rapid runs: 3
    Backup SPF: Not Needed

-------------------------------------
R1> run show ospf interface 
Interface           State   Area            DR ID           BDR ID          Nbrs
ge-0/0/0.0          BDR     0.0.0.0         2.2.2.2         1.1.1.1            1   <- Router 2 is DR
ge-0/0/1.0          BDR     0.0.0.0         4.4.4.4         1.1.1.1            1
ge-0/0/2.0          DR      0.0.0.0         1.1.1.1         3.3.3.3            1
lo0.0               DRother 0.0.0.0         0.0.0.0         0.0.0.0            0

-------------------------------------
R1# run show ospf neighbor 
Address          Interface              State           ID               Pri  Dead
10.0.12.2        ge-0/0/0.0             Full            2.2.2.2          128    33
10.100.14.2      ge-0/0/1.0             Full            4.4.4.4          128    39
10.0.13.3        ge-0/0/2.0             Full            3.3.3.3          128    33

@R1> show ospf neighbor 4.4.4.4 detail 
Address          Interface              State           ID               Pri  Dead
10.100.14.2      ge-0/0/1.0             Full            4.4.4.4          128    33
  Area 0.0.0.0, opt 0x52, DR 10.100.14.2, BDR 10.100.14.1
  Up 00:02:59, adjacent 00:02:51


-------------------------------------
R1# run show ospf interface 
Interface           State   Area            DR ID           BDR ID          Nbrs
ge-0/0/0.0          BDR     0.0.0.0         2.2.2.2         1.1.1.1            1
ge-0/0/1.0          BDR     0.0.0.0         4.4.4.4         1.1.1.1            1
ge-0/0/2.0          DR      0.0.0.0         1.1.1.1         3.3.3.3            1
lo0.0               DRother 0.0.0.0         0.0.0.0         0.0.0.0            0


-------------------------------------
R1# run show route protocol ospf 
inet.0: 17 destinations, 17 routes (17 active, 0 holddown, 0 hidden)
+ = Active Route, - = Last Active, * = Both

2.2.2.2/32         *[OSPF/10] 00:16:49, metric 1
                    >  to 10.0.12.2 via ge-0/0/0.0
3.3.3.3/32         *[OSPF/10] 00:05:20, metric 1
                    >  to 10.0.13.3 via ge-0/0/2.0
4.4.4.4/32         *[OSPF/10] 00:16:07, metric 1
                    >  to 10.100.14.2 via ge-0/0/1.0
10.0.24.0/24       *[OSPF/10] 00:01:09, metric 2
                    >  to 10.0.12.2 via ge-0/0/0.0
                       to 10.100.14.2 via ge-0/0/1.0
10.0.34.0/24       *[OSPF/10] 00:05:20, metric 2
                       to 10.100.14.2 via ge-0/0/1.0
                    >  to 10.0.13.3 via ge-0/0/2.0  -> note: you need to enable load balancing to load balance
10.100.23.0/24     *[OSPF/10] 00:05:20, metric 2
                       to 10.0.12.2 via ge-0/0/0.0
                    >  to 10.0.13.3 via ge-0/0/2.0  -> note: you need to enable load balancing to load balance
224.0.0.5/32       *[OSPF/10] 01:13:39, metric 1
                       MultiRecv

-------------------------------------
R1> run show ospf route 
Topology default Route Table:
Prefix             Path  Route      NH       Metric NextHop       Nexthop      
                   Type  Type       Type            Interface     Address/LSP
2.2.2.2            Intra Router     IP            1 ge-0/0/0.0    10.0.12.2
3.3.3.3            Intra Router     IP            1 ge-0/0/2.0    10.0.13.3
4.4.4.4            Intra Router     IP            1 ge-0/0/1.0    10.100.14.2
1.1.1.1/32         Intra Network    IP            0 lo0.0
2.2.2.2/32         Intra Network    IP            1 ge-0/0/0.0    10.0.12.2
3.3.3.3/32         Intra Network    IP            1 ge-0/0/2.0    10.0.13.3
4.4.4.4/32         Intra Network    IP            1 ge-0/0/1.0    10.100.14.2
10.0.12.0/24       Intra Network    IP            1 ge-0/0/0.0
10.0.13.0/24       Intra Network    IP            1 ge-0/0/2.0
10.0.24.0/24       Intra Network    IP            2 ge-0/0/0.0    10.0.12.2
                                                    ge-0/0/1.0    10.100.14.2
10.0.34.0/24       Intra Network    IP            2 ge-0/0/1.0    10.100.14.2
                                                    ge-0/0/2.0    10.0.13.3
10.100.14.0/24     Intra Network    IP            1 ge-0/0/1.0
10.100.23.0/24     Intra Network    IP            2 ge-0/0/0.0    10.0.12.2
                                                    ge-0/0/2.0    10.0.13.3


-------------------------------------
R1> show ospf database [<type:router/network/summary>| advertising-router <router-id>] [detail: to check the actual content of the LSAs]

R1> show ospf database router advertising-router 2.2.2.2 detail

    OSPF database, Area 0.0.0.0
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len 
Router   2.2.2.2          2.2.2.2          0x8000000f   458  0x22 0x5cf9  72
  bits 0x0, link count 4
  id 10.0.12.2, data 10.0.12.2, Type Transit (2)       <- type: transit>
    Topology count: 0, Default metric: 1
  id 10.100.23.2, data 10.100.23.1, Type Transit (2)   <- type: transit
    Topology count: 0, Default metric: 1
  id 10.0.24.2, data 10.0.24.2, Type Transit (2)
    Topology count: 0, Default metric: 1
  id 2.2.2.2, data 255.255.255.255, Type Stub (3)     <- type stub
    Topology count: 0, Default metric: 0
  Topology default (ID 0)
    Type: Transit, Node ID: 10.0.24.2
      Metric: 1, Bidirectional                             <- metric
    Type: Transit, Node ID: 10.100.23.2
      Metric: 1, Bidirectional                             <- metric
    Type: Transit, Node ID: 10.0.12.2
      Metric: 1, Bidirectional




R1> show ospf database network advertising-router 2.2.2.2 detail   

    OSPF database, Area 0.0.0.0
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len 
Network  10.0.12.2        2.2.2.2          0x80000007   598  0x22 0xb255  32   <- router 2 is DR so it sends the Network LSA for this segment
  mask 255.255.255.0
  attached router 2.2.2.2                                                      <- list of routers attached to the segment 
  attached router 1.1.1.1
  Topology default (ID 0)
    Type: Transit, Node ID: 1.1.1.1
      Metric: 0, Bidirectional
    Type: Transit, Node ID: 2.2.2.2
      Metric: 0, Bidirectional
Network  10.0.24.2        2.2.2.2          0x80000001  2163  0x22 0xd025  32
  mask 255.255.255.0
  attached router 2.2.2.2
  attached router 4.4.4.4
  Topology default (ID 0)
    Type: Transit, Node ID: 4.4.4.4
      Metric: 0, Bidirectional
    Type: Transit, Node ID: 2.2.2.2
      Metric: 0, Bidirectional

```


## Stub Area Configurations

Stub areas flag need to match in all routers. Here I only show the configuration of router R6 which is connected to R1 and R3 (but not showing R1 and R3).  
Because our initial design has no redistribution, the DB for a stub area is basically the same as for a normal area, i.e. Type-1, Type-2, Type-3.  
In order to see a difference we need to either:
- configure redistribution somewhere in the OSPF domain so to have type-5 LSAs moving around
- use the `no-summaries` flag on the **ABR** for the area to setup a **totally stub area**; this would remove specific type-3 LSAs 
  - contrary to Cisco world, a default route is not automatically 
- use the `set protocols ospf area <ID> stub default-metric <cost>`  to push a default type-3 LSA into the area.  
- use the `set protocols ospf area <ID> stub no-summaries default-metric <cost>`  to push a default type-3 LSA into the area and remove the summaries.  
   


```
[R5]
!
set protocols ospf area 0.0.0.1 stub 
!        
! alternatives for ABRs (these 2 commands can be used together in a single line):
! set protocols ospf area 0.0.0.1 stub no-summaries     -> this will remove summaries (no default is sent out)
! set protocols ospf area 0.0.0.1 stub default-cost 10  -> this will push a type-3 default (but won't remove the summaries)
!
!
! -----------> SHOW COMMANDS
!
! run show ospf overview
R5> show ospf overview 
Instance: master
  Router ID: 6.6.6.6
  Route table index: 0
  LSA refresh time: 50 minutes
  Post Convergence Backup: Disabled
  Area: 0.0.0.1
    Stub type: Stub                        <--- stub area
    Authentication Type: None
    Area border routers: 2, AS boundary routers: 0
    Neighbors
      Up (in full state): 2
[...]]

# run show ospf database
@R5# run show ospf database 

    # run show ospf database 

    OSPF database, Area 0.0.0.1
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len 
Router   10.100.100.1     10.100.100.1     0x80000005    18  0x20 0x532d  48
Router   10.100.100.3     10.100.100.3     0x80000004    18  0x20 0xde75  48
Router  *10.100.100.5     10.100.100.5     0x80000006    57  0x20 0xf071  60  --> entries with * are generated locally
Network  10.100.13.2      10.100.100.3     0x80000001    18  0x20 0xed51  32
Network *10.100.15.2      10.100.100.5     0x80000001    65  0x20 0xdf59  32
Network *10.100.35.2      10.100.100.5     0x80000001    57  0x20 0x1f04  32
Summary  10.100.12.0      10.100.100.1     0x80000002    18  0x20 0xb13d  28  --> All summaries will disappear if you use no-summaries or default-cost
Summary  10.100.12.0      10.100.100.3     0x80000002    17  0x20 0xaf3c  28
Summary  10.100.14.0      10.100.100.1     0x80000002    18  0x20 0x9b51  28
[...]                                                                         --> no AS scoped type 5 present here 

! On the R3 ABR (with 8.8.8.8 redistributed by R1)
@R3# run show ospf database 

    OSPF database, Area 0.0.0.0                                             --> Area 0
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len 
Router   10.100.100.1     10.100.100.1     0x80000005    25  0x22 0x613b  60
Router   10.100.100.2     10.100.100.2     0x80000004   284  0x22 0x1d6c  60
Router  *10.100.100.3     10.100.100.3     0x80000004   283  0x22 0x2139  60
Router   10.100.100.4     10.100.100.4     0x80000004   291  0x22 0xa1c6  60
Network  10.100.12.2      10.100.100.2     0x80000001   289  0x22 0xd669  32
Network  10.100.14.2      10.100.100.4     0x80000001   301  0x22 0xc871  32
Network *10.100.23.2      10.100.100.3     0x80000001   283  0x22 0x6fc2  32
Network  10.100.34.2      10.100.100.4     0x80000001   293  0x22 0x81c   32
Summary  10.100.13.0      10.100.100.1     0x80000008    25  0x22 0x7c69  28
[...]                                                                       --> Note: type 5 are not shown per area but globally

   OSPF database, Area 0.0.0.1                                             --> Area 1
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len 
Router   10.100.100.1     10.100.100.1     0x80000002    24  0x20 0x7987  48
Router  *10.100.100.3     10.100.100.3     0x80000002    14  0x20 0xf4df  48
Router   10.100.100.5     10.100.100.5     0x80000006    15  0x20 0xf071  60
Network  10.100.15.2      10.100.100.5     0x80000001    23  0x20 0xdf59  32
Network  10.100.35.2      10.100.100.5     0x80000001    15  0x20 0x1f04  32
Summary  10.100.12.0      10.100.100.1     0x80000001    24  0x20 0xb33c  28
[...]
]
    OSPF AS SCOPE link state database                                      --> AS SCope section, you can see the type 5 here 
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len 
Extern   8.8.8.8          10.100.100.1     0x80000001    25  0x22 0x4d71  36

```

### Not-So-Stubby Area (nssa)
This is basically the same as the **stub** but it will also allow for local redistribution.
- configure redistribution somewhere in the OSPF domain so to have type-5 LSAs moving around
- configure redistribution in the NSSA area to have Type-
- use the `no-summaries` flag for the area ans basically setup a **totally stub area**; this would remove specific type-3 LSAs 
  - contrary to Cisco world, a default route is not automatically generated, so you need to manually add in the **ABR**:  
    `set protocols ospf area <ID> nssa default-lsa default-metric <cost>`  
    Adding the default-metric option will create the **default summary LSA**

```
[R5]
!
set protocols ospf area 0.0.0.1 nssa
!
!
cluser@R5# run show ospf database 

    OSPF database, Area 0.0.0.1
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len 
Router   10.100.100.1     10.100.100.1     0x80000005   470  0x20 0x5925  48
Router   10.100.100.3     10.100.100.3     0x80000003   468  0x20 0xe66c  48
Router  *10.100.100.5     10.100.100.5     0x80000004   467  0x20 0xf46f  60
Network  10.100.13.2      10.100.100.3     0x80000001   471  0x20 0xed51  32
Network *10.100.15.2      10.100.100.5     0x80000001   483  0x20 0xdf59  32
Network *10.100.35.2      10.100.100.5     0x80000001   467  0x20 0x1f04  32
Summary  10.100.12.0      10.100.100.1     0x80000004   468  0x20 0xad3f  28
[...]
]NSSA     8.8.8.8          10.100.100.1     0x80000001   525  0x20 0x4f6f  36    <- coming from R1
!
!
!
!
[R1] 
! This is doing redistribution
!
set routing-options static route 8.8.8.8/32 receive
set policy-options policy-statement type5_lsa term 1 from protocol static
set policy-options policy-statement type5_lsa term 1 from route-filter 8.8.8.8/32 exact
set policy-options policy-statement type5_lsa term 1 then accept
!
!
set protocols ospf area 0.0.0.0 interface lo0.0 passive
set protocols ospf area 0.0.0.1 nssa
set protocols ospf area 0.0.0.1 interface ge-0/0/2.0
set protocols ospf area 0.0.0.1 interface ge-0/0/3.0
set protocols ospf export type5_lsa
!
!
R1# run show ospf database 

    OSPF database, Area 0.0.0.0                                                --> Area 0
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len 
Router  *10.100.100.1     10.100.100.1     0x80000007   211  0x22 0x5d3d  60
Router   10.100.100.2     10.100.100.2     0x80000005   492  0x22 0x1b6d  60
Router   10.100.100.3     10.100.100.3     0x80000006    71  0x22 0x2333  60
[...]                                                                          --> note there is no external here.. they are shown globally
Summary  10.100.100.6     10.100.100.4     0x80000002   159  0x22 0x7912  28   

    OSPF database, Area 0.0.0.1                                                --> Area 1
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len 
Router  *10.100.100.1     10.100.100.1     0x80000005   545  0x20 0x5925  48
Router   10.100.100.3     10.100.100.3     0x80000003   544  0x20 0xe66c  48
Router   10.100.100.5     10.100.100.5     0x80000004   544  0x20 0xf46f  60
[...]
Summary  10.100.100.6     10.100.100.3     0x80000001   586  0x20 0xa9e4  28
NSSA    *8.8.8.8          10.100.100.1     0x80000001   600  0x20 0x4f6f  36 --> we do have an NSSA in the area database (because these are bound to the area)
    OSPF AS SCOPE link state database
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len --> Global AS
Extern  *8.8.8.8          10.100.100.1     0x80000003    71  0x22 0x4973  36 --> here we have the type-5

```
Note: in the previous show we don't see any type-4 ASBR Summary LSA because the ASBR are always local to the areas we were checking.
However if we check from a router in a different Area we will also get ASBR type-4.  
In particular, it's enough to configure a router as an ABR for an **NSSA** and we will automatically have a type-4 LSA for that router.
```
R6 is in AREA 2 connected to area0 via R2 and R4
R1 has one interface in AREA 0 and one in AREA 1 (nssa)
R2 has one interface in AREA 0 and one in AREA 1 (nssa)
R1 is redistribution a static route into ospf

!
! R6 sees 2 ASBRs: R1 and R3 and for each it gets 2 type-4 LSA (from R2 and R4)
! R3 is listed just because it has one interface in a NSSA stub area
! even if redistribution is removed from R1, R6 will still get these type-4 LSAs
R6# run show ospf database asbrsummary 

    OSPF database, Area 0.0.0.2
 Type       ID               Adv Rtr           Seq      Age  Opt  Cksum  Len 
ASBRSum  10.100.100.1     10.100.100.2     0x80000009    16  0x22 0x9bee  28
ASBRSum  10.100.100.1     10.100.100.4     0x80000009    16  0x22 0x8ff8  28
ASBRSum  10.100.100.3     10.100.100.2     0x80000002    16  0x22 0x95f9  28
ASBRSum  10.100.100.3     10.100.100.4     0x80000002    16  0x22 0x8904  28

```



## OSPF Timers
You can modify OSPF timers: **hello, dead, retransmit** but do remember to keep them consistent or neighbours will not come up.  
Timers are set at interface level:
```
R6# run show ospf interface detail 
Interface           State   Area            DR ID           BDR ID          Nbrs
ge-0/0/3.0          DR      0.0.0.2         10.100.100.6    10.100.100.2       1
  Type: LAN, Address: 10.100.26.2, Mask: 255.255.255.0, MTU: 1500, Cost: 1
  DR addr: 10.100.26.2, BDR addr: 10.100.26.1, Priority: 128
  Adj count: 1
  Hello: 10, Dead: 40, ReXmit: 5, Not Stub                                     <-- Hello, Dead, ReXmit  
[...]
!

R6# set protocols ospf area 2 interface ge-0/0/3.0 hello-interval 15 dead-interval 60 retransmit-interval 12 
!
!
R6# run show ospf interface detail                                                                              
Interface           State   Area            DR ID           BDR ID          Nbrs
ge-0/0/3.0          DR      0.0.0.2         10.100.100.6    10.100.100.2       1
  Type: LAN, Address: 10.100.26.2, Mask: 255.255.255.0, MTU: 1500, Cost: 1
  DR addr: 10.100.26.2, BDR addr: 10.100.26.1, Priority: 128
  Adj count: 1
  Hello: 15, Dead: 60, ReXmit: 12, Not Stub                      <- changed>
[...]
!
!
! we can also see general stats:
R6# run show ospf statistics 
Packet type             Total                  Last 5 seconds
                   Sent      Received        Sent      Received
   Hello            828           758           1             1
     DbD             26            32           0             0
   LSReq              4             4           0             0
LSUpdate            182           312           1             0
   LSAck            173           155           1             0

DBDs retransmitted     :                    8, last 5 seconds :          0
LSAs flooded           :                  335, last 5 seconds :          6
LSAs flooded high-prio :                  176, last 5 seconds :          0
LSAs retransmitted     :                    1, last 5 seconds :          0
LSAs transmitted to nbr:                   32, last 5 seconds :          0
LSAs requested         :                   74, last 5 seconds :          0
LSAs acknowledged      :                  621, last 5 seconds :          6

Flood queue depth      :               0
Total rexmit entries   :              13
db summaries           :               0
lsreq entries          :               0

Receive errors:
  6 hello interval mismatches                  <-- because I did not change the peer we got some mismatch!!!


```



## OSPF Authentication
OSPF Supports 3 types of authentication: **simple password, md5, ipsec**. 
As for the timers, authentication is configure per link basis
```
R1# run show ospf interface detail                                                                              
ge-0/0/0.0          BDR     0.0.0.0         10.100.100.2    10.100.100.1       1
  Type: LAN, Address: 10.100.12.1, Mask: 255.255.255.0, MTU: 1500, Cost: 1
  DR addr: 10.100.12.2, BDR addr: 10.100.12.1, Priority: 128
  Adj count: 1
  Hello: 10, Dead: 40, ReXmit: 5, Not Stub
  Auth type: None                                  <-- No authentication
  Protection type: None                            <-- No IPSEC protection
[...]

R1# set protocols ospf area 0 interface ge-0/0/0.0 authentication simple-password PASSWORD 
R1# show | compare 
[edit protocols ospf area 0.0.0.0 interface ge-0/0/0.0]
+      authentication {
+          simple-password "$9$pwJ.uIhSyeWXNHqIhrvXxDjHk.f"; ## SECRET-DATA
+      }

R1# run show ospf interface detail    
Interface           State   Area            DR ID           BDR ID          Nbrs
ge-0/0/0.0          BDR     0.0.0.0         10.100.100.2    10.100.100.1       1
  Type: LAN, Address: 10.100.12.1, Mask: 255.255.255.0, MTU: 1500, Cost: 1
  DR addr: 10.100.12.2, BDR addr: 10.100.12.1, Priority: 128
  Adj count: 1
  Hello: 10, Dead: 40, ReXmit: 5, Not Stub
  Auth type: Password                             <-- authentication enabled now>
  Protection type: None  
[...]  


!
! For md5
! You need to specify a key-id and THEY MUST MATCH AT BOTH SIDES!!!!  
! You can also specify a start time for a key and have multiple keys (for key rotation)
R1# set protocols ospf area 0 interface ge-0/0/0.0 authentication md5 1 key PASSWORD  

R1# run show ospf interface detail    
Interface           State   Area            DR ID           BDR ID          Nbrs
ge-0/0/0.0          DR      0.0.0.0         10.100.100.2    10.100.100.1       1
  Type: LAN, Address: 10.100.12.2, Mask: 255.255.255.0, MTU: 1500, Cost: 1
  DR addr: 10.100.12.2, BDR addr: 10.100.12.1, Priority: 128
  Adj count: 1
  Hello: 10, Dead: 40, ReXmit: 5, Not Stub
  Auth type: MD5, Active key ID: 1, Start time: 1970 Jan  1 00:00:00 UTC  <-- MD5 auth with key id 1
  Protection type: None
  Topology default (ID 0) -> Cost: 1
```

## OSPF BFD and OSPF TRACE Files
OSPF is not super quick to identify neighbours down so you can configure BFD and make it more reactive.  
BFDs are configure at the itnerface level:
```
[edit]
jcluser@R2# set protocols ospf area 0.0.0.0 interface ge-0/0/0.0 bfd-liveness-detection minimum-interval 1000 multiplier 4  

[edit]
jcluser@R2# show | compare 
[edit protocols ospf area 0.0.0.0 interface ge-0/0/0.0]
+      bfd-liveness-detection {
+          minimum-interval 200;                  ! -> millisec; interval between packets
+          multiplier 4;                          ! -> how many packets to lose before declaring the neighbour down   
+          full-neighbors-only;                   ! -> this is applied only for neighbors that are in FULL state 
+      }                                          !    (i.e. DR/BDR only in a Multi Access segment)


!
!
! --------------------   SHOW COMMANDS (need to be configured on all sides for session to be up!)
jcluser@R2# run show bfd session
                                                  Detect   Transmit
Address                  State     Interface      Time     Interval  Multiplier
10.100.12.1              Up        ge-0/0/0.0     4.000     1.000        4   

1 sessions, 1 clients
Cumulative transmit rate 1.0 pps, cumulative receive rate 1.0 pps


jcluser@R2# run show bfd session detail 
                                                  Detect   Transmit
Address                  State     Interface      Time     Interval  Multiplier
10.100.12.1              Up        ge-0/0/0.0     4.000     1.000        4   
 Client OSPF realm ospf-v2 Area 0.0.0.0, TX interval 1.000, RX interval 1.000       <- shows that OSPF is monitoring this
 Session up time 00:00:16
 Local diagnostic None, remote diagnostic None
 Remote state Up, version 1
 Session type: Single hop BFD

1 sessions, 1 clients
Cumulative transmit rate 1.0 pps, cumulative receive rate 1.0 pps

```

To setup a trace file (i.e. debug) for OSPF, the process is basically the same as to setup a trace file for everything else:
```
R2# set protocols ospf traceoptions file OSPF_TRACE    
# set protocols ospf traceoptions flag ?                       --> possible tings to trace
Possible completions:
  all                  Trace everything
  backup-spf           Trace backup SPF (LFA) specific events
  database-description  Trace database description packets
  error                Trace errored packets
  event                Trace OSPF state machine events
  flex-algorithm       Trace flex-algorithm related events
  flooding             Trace LSA flooding
  general              Trace general events
  graceful-restart     Trace graceful restart
  hello                Trace hello packets
  ldp-synchronization  Trace synchronization between OSPF and LDP
  lsa-ack              Trace LSA acknowledgment packets
  lsa-analysis         Trace LSA analysis
  lsa-request          Trace LSA request packets
  lsa-update           Trace LSA update packets
  normal               Trace normal events
  nsr-synchronization  Trace NSR synchronization events
  on-demand            Trace demand circuit extensions
  packet-dump          Dump the contents of selected packet types
  packets              Trace all OSPF packets
  policy               Trace policy processing
  post-convergence-lfa  Trace post-convergence-lfa related events
  restart-signaling    Trace restart signaling
  route                Trace routing information
  source-packet-routing  Trace source packet routing (SPRING) events
  spf                  Trace SPF calculations
  state                Trace state transitions
  task                 Trace routing protocol task processing
  timer                Trace routing protocol timer processing

[edit]
! we monitor hello nad errors
jcluser@R2# set protocols ospf traceoptions flag hello detail
jcluser@R2# set protocols ospf traceoptions flag error

[edit]

!------------------------------------- SHOW COMMANDS

@R2# run show log ?  
Possible completions:
  <[Enter]>            Execute this command
  <filename>           Name of log file
  OSPF_TRACE           Size: 67, Last changed: May 27 10:40:20              <-- This is the trace file just created
[...]


@R2# run show log OSPF_TRACE                                                <-- will show the file
May 27 10:40:20 trace_on: Tracing to "/var/log/OSPF_TRACE" started
May 27 10:42:42.059916 RPD_OSPF_NBRDOWN: OSPF neighbor 10.100.12.1 (realm ospf-v2 ge-0/0/0.0 area 0.0.0.0) state changed from Full to Down due to InActiveTimer (event reason: neighbor was inactive and declared dead)
May 27 10:42:55.330173 ospf_evaluate_intf_spring_lan_adj_sids No  LAN Adj SIDs config found on Intf ge-0/0/0.0
May 27 10:42:55.330256 ospf_evaluate_intf_spring_adj_sids_knob Restoring Default Dynamic Adj SIDs Behavior on intf ge-0/0/0.0
May 27 10:42:55.330278 task_job_create_background: create prio 4 job Interface event subjob UNNAMED for task OSPF
[...]



@R2# run # run monitor start OSPF_TRACE                                   <-- will monitor the file (like tail -f <file>)

May 27 10:55:38.636777 OSPF periodic xmit from 10.100.12.2 to 224.0.0.5 (IFL 340 area 0.0.0.0)
May 27 10:55:38.666077 OSPF packet ignored: authentication failure (bad cksum).                   <- I've change the MD5 pwd in the neighbor
May 27 10:55:38.666117 OSPF packet ignored: authentication failure from 10.100.12.1               <- so we get an authentication error 
May 27 10:55:38.910149 OSPF periodic xmit from 10.100.23.1 to 224.0.0.5 (IFL 341 area 0.0.0.0)    <- transmit hello
May 27 10:55:41.240258 OSPF periodic xmit from 10.100.26.1 to 224.0.0.5 (IFL 332 area 0.0.0.2)
May 27 10:55:41.504175 OSPF hello from 10.100.24.2 (IFL 342, area 0.0.0.2) absorbed               <- received hello
May 27 10:55:42.126559 OSPF hello from 10.100.26.2 (IFL 332, area 0.0.0.2) absorbed
May 27 10:55:42.144913 OSPF periodic xmit from 10.100.24.1 to 224.0.0.5 (IFL 342 area 0.0.0.2)
May 27 10:55:57.332183 OSPF periodic xmit from 10.100.26.1 to 224.0.0.5 (IFL 332 area 0.0.0.2)
[...]
```