# OSPF - NOTES

## AD Reminder 
This is the AD used by cisco for different types of routes/protocols:
* IBGP 200
* EIGRP redistributed 170
* ODR 160
* RIP 120
* OSPF 110
* EIGRP 90
* EBGP 20
* EIGRP summary 5

## OSPF Adjeciencies
To form an OSPF adjacency, some attributes must **match** between neighbors, while others must be **unique**. 
The common attributes that must **match** are:
* the area number 
* timers
* authentication 
* stub flags
* MTU (this can be disabled)
* compatible network types (i.e. DR or non DR requirements). 
  * Note some specific network types (e.g. broadcast) also check the subnet mask (unless the interface is getting an unnumbered IP)

The attributes that must be **unique** are:
* The interface IP addresses 
* The **router-ids**: the LSA origination is based on the router-id and each router needs a unique id within the OSPF domain; 
  Two routers with the same router-id cannot become neighbors.  
  The router-id is a 32-bit number and is chosen, in order of priority, based on:
    * the process-level ```router-id``` command 
    * if not set in the process, the *highest* active *Loopback IP* interface
    * the *highest active non-Loopback* interface IP address. 

Note: hello packets are sent to 224.0.0.5 and they contain router-id and neighbours seen

## LSA types.
LSA are usually **flooded** every **30 min** to avoid and they **age out in 1 hour** to avoid excessive traffic and computation.  
```Flood reduction``` can be configured per interface and it will set the flag **DoNotAge** in the LSA, that will stop the periodic flood.

The different types of LSA are:  
1. **Type-1:** **router LSA**: contains router id and its links  
    There are 4 link types:
     *	Point-to-point connection to another router.	Neighbor router ID
     *  Connection to transit network.	IP address of DR
     *  Connection to stub network.	IP Network  
     * 	Virtual Link	Neighbor router ID
1. **Type-2:** **Network Link LSA** sent by the elected Designated Router DR (if the networks type is either **broadcast or non-broadcast**)
     The LSA describes the DR and the neighbours attached to the segment
1. **Type-3:** **Network Summary LSA** sent by Area Border Router **(ABR)** to advertise prefixes beyween Areas.   
     An ABR connects to **area 0** and another area and it creates and sends type-3 LSA for:
    *  LSA from other Areas into Area0
    * LSA from Area0 into other Areas  

    Notes: 
    * if a router is not connected to area0 but to other areas it will not send type-3 LSAs    
    * If a DR receives a type-3 LSA, it also replicates it and sends it to the other routers in the segment
    * The value of the next hop in the Type3 LSA does not change (i.e. it is the router that generated the type3 LSA) unless it transit yet to another Area..  
    E.G  consider: ```R1 - (Area2) - R2 - (Area0) - R3 (Area0) - R4 - (Area1) - R5```  
      *  R2 will generate a type-3 LSA for R1 routes from Area2 into Area0
      *  The next hop in the LSA type-3 will be R2, when the LSA is in Area0
      *  The next hop in the LSA type-3 will be changed to R4 when the LSA goes into Area1

1. **Type-4:** **ASBR**: contains information about **AS Border Routers**; it is generated by an **ABR** when  
   they receive a **type-5 LSA** from a router in their area;   
    The ABR knows about the exist point (ASBR) in the same area via Type-1 LSA
1. **Type-5:** **External routes**: generated by **ASBR** when routes from other routing protocols (or static) are 
   imported. They are flooded unchanged and there are **2 types** of this LSA based on how the costs are recorded:
    * Type-1: E1 the cost to reach the network changes and it includes the cost to reach the **ASBR** 
    * Type-2: E2 The metric is fixed. It is set by the **ASBR** when the route is imported
     If there is a tie to reach the prefix from different ASBRs, the cost to reach the ASBR
     is considered as tie breaker
     (metric fixed by asbr)  

   Notes:
     * Type-5 LSA are also generated as conversion from a type-7 (that can only exist in **NSSA** areas), so 
       when an **ABR** receives a type-7, a type-5 is generated and forwarded to area0 instead
     * when a type-5 is generated from a type-1 or type-2, the **forward-address** is usually **0.0.0.0**  
     * when a type-5 is generted from a type-7 the forward address can be set..  
       There are differences between normal ABR and NSSA ABR and also `foward address suppression` can be enabled  
       So overall, they can have a forward address (if converted from type-7) or not..

1. **Type-7:** - **NSSA External** - similar to Type-5 but generated in a NSSA area.  
   There are 2 types of this LSA: **N1** and **N2** that set the prefix cost in the same way as E1 and E2.   
   It is translated to type-5 by ABR when entering area 0     


## Timers
### hello, wait, dead
**hello timer**: is self explanatory. The frequencty is **10 seconds** for *point to point* and *broadcast*.  
**dead timer**: time after which a neighbor is dead (and DR/BDR re-election can happen). It is 4 times the hello time.    
**wait time**: It is used to:
  *  declare the router itself a DR if no other DR has announced themselves in the segment
     in this case it is only used when a router starts up and it is not configurable but always equal to the **dead timer**
  *  wait after receiving an LSA on an interface before starting processing it.. this is used in case other updates are expected. The default in this case is zero seconds.
 

**Timers** are based on the network-type configured on an interface and they need to match to establish a neighbour but you can theoretically set them manually and have 2 different types
of interfaces (probably not a good idea though.. you also need to be sure that the requirements
for DR/BDR are consistent.)
```
! interface timers configuration commands:
interface <X>
   ip ospf hello-interval 5
   ip ospf dead-interval 7    

! Note: if hello packets are required very frequently (e.g. 4 per second)
! you can force sub seconds hello with:
ip ospf dead-interval minimal hello-multiplier 4   
```

Other timers are availble in global OSPF process for: **pacing, retransmission, throttle,etc..**

**On demand** this is not a timer but a configuration you can apply to suppressed hellopackets and set set LSAs with the **do not age** flag. This means that the adjacency will remain up even after the layer two of the circuit goes down. It was mainly used on pay-per-packet circuits (e.g. ISDN).  
It is enabled with the interface command: `ip ospf demand-circuit`

## Network Types

### Network type BROADCAST
A DR and BDR are elected, routers go FULL state with DR/BDR.
Routers go 2-WAY with other routes (meaning they see each other but do not exchange info).  
Notes:
*  DR is elected based on highest **priority** and highest **router-id** on the segment (BDR comes second)
*  DR/BDR election is non pre-emptive; 
*  **priority** is set to zero in an interface to avoid taking part to the election process
* communications is using **224.0.0.5** for normal routers and **224.0.0.6** for communication between the DR and BDR
* hello packets are multicast


### Network type NON-BROADCAST
A DR and BDR are elected, routers go FULL state with DR/BDR
* this is still a multiple access network but broadcast is not supported (e.g. dmvpn if no multicast support is configured)
* it will still have DR/BDR election because it is mutliple access and DR must be on the hub
   (so priority is set to 0 on the spokes)
* use the command on the interface to activate
* use the ```neighbor``` command under the process for peering 
* hello packets are unicast


### Network type POINT-TO-POINT
* No DR/BDR election (because only 2 routers in the segment) broadcast is supported 
  This is the default for tunnel and other pont-2-point interfaces
* hello is multicast  
* configured on ```Loopback``` interfaces to advertise the actual mask


### Network type POINT-TO-MULTIPOINT
* No DR/BDR election
* hello are multicast
* neighbors go up to FULL state
* next hop in LSA3 changes to the ip of the hub router (it was not changed before)
  (all routes learned by the hub?)
* support cost per niehgbor

### Network type POINT-TO-MULTIPOINT NON BROADCAST
* No DR/BDR election
* hello are unicast
* support cost per niehgbor

## AREA Types

Flags need to match in all routers of the same area.
1. **Stub**  : command: ```area <X> stub```  
  This command removes Type-5 LSA and replace them with a default route **(O IA)**.  
  TYpe-5 routes are ignored by stub routers
1. **Totally Stub** : command: ```area <X> stub no-summary```  
   This command removes Type-3 / Type-5 LSA and replace them with a default route type **(O IA)**.   
   The ```no-summary``` is only required in the **ABR** with area 0
1. **Not-So-Stubby**: command: ```area <X> nssa```  
   This command allows for the redistribution of external routes as Type-7 inside the NSSA.   
   A **default route** is **not** automatically **generated** but you can generate one with the option:  
   ```area <X> nssa default-information-originate```  
  If multiple **ABRs** connect the NSSA area to area0 the ABR with highest router id becomes the only router translating Type7 to type5 LSA.  
  If the **ABR** is also the **ASBR**, routes are generated as type-5 in area0 and type-7 in the NSSA, but if the type-7 are not required (e.g. there is a default) so, they can be suppressed with the command: ```area <X> nssa no-redistribution```
1. **Not-so-totally-stubby**: combination of the totally-stubby area and the NSSA. Like the  
   totally-stubby area, Type-3, Type-4 and Type-5 are removed and replaced with a Type-3 Summary LSA default route. Type-7 NSSA External LSAs are still allowed to be originated inside the area.    
   Note: you can use either: ```area <X> nssa no-summary``` (**type-3 LSA default route**) or  ```area <X> nssa default-information-originate``` (**type-5 LSA default route**) to control 
   the exit point from the Area (type-3 would be preferred and type-5 used as backup)          



##  Path selection
* SPF is only calculated intra-area
* ABR are trusted for external area calculations (exception E2/N2)
  The cost to a summary nework (type-3 LSA) is the cost computed by the ABR
  plus the cost to reach the ABR
* Note when a node goes down, LSAs stay in the DB until their aging timer expires but
  the router will be declared down after the dead time.. so its LSAs will not be used
* transit through a non backbone area can be enabled/disabled with the command: ```[no] capability transit```. If enabled, non backbone areas can be used for transit if they have better cost  

## VIRTUAL LINKS
* An OSPF virtual-link allows the creation of an indirect area 0 adjacency. 
* The IP specified in the virtual link command is the router id
  The neighbors forming adjacency over the virtual-link do not have to be directly connected; 
* does not support periodic hello, if authentication is enabled, clear the process to refresh  


## Summarization, Filters and default routing 
### INTER AREA
Because all goes through area0 it makes sense to make summary from other areas into area 0.  
Use the command: ```area <source> range <summary> <mask>``` to create **type-3** summary.  
If you have more than one entry point to area 0 you can summarize in one and keep the *longest match*  
in the other one; the longest match will be chosen no matter the metrics, the *summary* will be used  
as backup.  
Rememeber that a ```null0``` route is usally created but it **can be disabled** with the command: 
```no discard-route <internal/external>```

### EXTERNAL
It can be done only in **ASBR** routers:
1. The command: ```summary-address <summary> <mask>``` creates LSA Type 5 External Type 1 
1. Use FILTER-LIST (type-3)
   * only between areas
   * can be applied with prefix-list
   * you can specify an area and a direction 
   
   eg. ```area <ID> filter-list prefix <p_list> <in/out>```
1. DISTRIBUTE-LIST:
   * used distribute list to filter intra area routes 
   * can use route-maps
   * inbound (router process)
1. FILTER WITH AD:
   * set to **255** to discard the route from being installed
   * command: dist```ance <distance> <source> <mask> <acl with prefixes to match>```  
     Note that here the  source needs to match the **router id** of the src
1. DATABASE FILTER-ALL
   * similar to passive-inerface
   * discard all the LSA to a neighbor or out an interface
   * Hello packets still sent (but no LSA)
1. MAX-METRIC
   * command: ```max-metric router-lsa```
   * used to isolate a router (for maintenance for instance) 
   * option to use on-startup wait-for-bgp to wait for bgp convergence   
1. DEFAULT-ROUTE
   * **stub/nssa**: no-summary generates  type-3 default
   * **nssa**: default information originate type-5 default
   * default-information originate: 
      * generates a type-5 (a default must be present)
      * if the keyword ```always``` is used, the default route is not required anymore
      * can be done conditionally matching a **prefix-list** in a **route-map**  
        and note that the prefix can match a static route with a track (**reliable conditional**)

                      
    
## MISC
* Number of max LSA (and redistributed routes ) can be fixed
* MTU should match between neighbour but check can be disabled
* Multicast OSPF (type-6) can be ignored    
* auto-cost reference-bandwidth <X> -> change the reference of cost of an interface
* interface cost can be set: ip ospf cost <X>
